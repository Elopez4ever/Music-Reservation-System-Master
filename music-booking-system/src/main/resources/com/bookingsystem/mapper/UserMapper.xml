<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookingsystem.mapper.UserMapper">
    <insert id="insert">
        INSERT INTO users
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="username != null">username,</if>
            <if test="password != null">password,</if>
            <if test="realName != null">real_name,</if>
            <if test="studentId != null">student_id,</if>
            <if test="email != null">email,</if>
            <if test="phone != null">phone,</if>
            <if test="userType != null">user_type,</if>
            <if test="departmentId != null">department_id,</if>
            <if test="avatarUrl != null">avatar_url,</if>
            <if test="status != null">status,</if>
            <if test="createdAt != null">created_at,</if>
            <if test="updatedAt != null">updated_at,</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            <if test="username != null">#{username},</if>
            <if test="password != null">#{password},</if>
            <if test="realName != null">#{realName},</if>
            <if test="studentId != null">#{studentId},</if>
            <if test="email != null">#{email},</if>
            <if test="phone != null">#{phone},</if>
            <if test="userType != null">#{userType},</if>
            <if test="departmentId != null">#{departmentId},</if>
            <if test="avatarUrl != null">#{avatarUrl},</if>
            <if test="status != null">#{status},</if>
            <if test="createdAt != null">#{createdAt},</if>
            <if test="updatedAt != null">#{updatedAt},</if>
        </trim>
    </insert>
    <!-- 更新用户信息 -->
    <update id="update" parameterType="com.bookingsystem.pojo.User">
        UPDATE users
        <set>
            <if test="password != null and password != ''">
                password = #{password},
            </if>
            <if test="realName != null and realName != ''">
                real_name = #{realName},
            </if>
            <if test="avatarUrl != null and avatarUrl != ''">
                avatar_url = #{avatarUrl},
            </if>
            <if test="studentId != null and studentId != ''">
                student_id = #{studentId},
            </if>
            <if test="email != null and email != ''">
                email = #{email},
            </if>
            <if test="phone != null and phone != ''">
                phone = #{phone},
            </if>
            <if test="userType != null and userType != ''">
                user_type = #{userType},
            </if>
            <if test="departmentId != null">
                department_id = #{departmentId},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="lastLoginTime != null">
                last_login_time = #{lastLoginTime},
            </if>
            <if test="lastLoginIp != null and lastLoginIp != ''">
                last_login_ip = #{lastLoginIp},
            </if>
            <if test="updatedAt != null">
                updated_at = #{updatedAt},
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="delete">
        delete from users where id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    <select id="list" resultType="com.bookingsystem.vo.UserQueryVo">
        select u.id, u.username,u.real_name,u.student_id,u.user_type,u.email,u.status,d.name as department_name, u.phone,u.avatar_url,u.last_login_time,u.last_login_ip,u.created_at,u.updated_at,
        IFNULL(res_stats.reservation_count, 0) AS reservation_count,
        IFNULL(res_stats.cancel_count, 0) AS cancel_count
        from users u  LEFT join departments d on u.department_id = d.id
        LEFT JOIN (
        SELECT
        user_id,
        COUNT(*) AS reservation_count,
        SUM(CASE WHEN status = 'cancelled' THEN 1 ELSE 0 END) AS cancel_count
        FROM reservations
        GROUP BY user_id
        ) res_stats ON u.id = res_stats.user_id
        <where>
            user_type NOT IN ('admin', 'super_admin')
            <if test="userType != null and userType != ''">
                and user_type = #{userType}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="usernameOrRealNameOrStudentId != null and usernameOrRealNameOrStudentId != ''">
                AND (
                username LIKE CONCAT('%', #{usernameOrRealNameOrStudentId}, '%')
                OR real_name LIKE CONCAT('%', #{usernameOrRealNameOrStudentId}, '%')
                OR phone LIKE CONCAT('%', #{usernameOrRealNameOrStudentId}, '%')
                )
            </if>
        </where>
    </select>
    <select id="selectAdmins" resultType="com.bookingsystem.vo.UserQueryVo">
        select u.id, u.username,u.real_name,u.student_id,u.user_type,u.email,u.status,d.id as department_id,d.name as department_name, u.phone from users u  LEFT join departments d on u.department_id = d.id
        <where>
                user_type = 'admin'
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="usernameOrRealNameOrStudentId != null and usernameOrRealNameOrStudentId != ''">
                AND (
                username LIKE CONCAT('%', #{usernameOrRealNameOrStudentId}, '%')
                OR real_name LIKE CONCAT('%', #{usernameOrRealNameOrStudentId}, '%')
                OR student_id LIKE CONCAT('%', #{usernameOrRealNameOrStudentId}, '%')
                )
            </if>
        </where>
    </select>
    <select id="selectByUsername" resultType="com.bookingsystem.pojo.User">
        select u.id,u.avatar_url,u.password,u.phone, u.username,u.real_name,u.student_id,u.user_type,u.email,u.status,d.id as department_id,d.name as department_name, u.phone
        from users u  LEFT join departments d on u.department_id = d.id
        where username = #{username}
    </select>
</mapper>