<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookingsystem.mapper.ReservationMapper">


    <resultMap id="ReservationBaseMap" type="com.bookingsystem.pojo.Reservation">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="roomId" column="room_id"/>
        <result property="title" column="title"/>
        <result property="purpose" column="purpose"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="attendees" column="attendees"/>
        <result property="status" column="status"/>
        <result property="remarks" column="remarks"/>
        <result property="reviewerId" column="reviewer_id"/>
        <result property="reviewTime" column="review_time"/>
        <result property="reviewRemarks" column="review_remarks"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="roomName" column="room_name"/>
        <result property="username" column="username"/>
        <result property="phone" column="phone"/>
    </resultMap>
    <update id="update" parameterType="com.bookingsystem.pojo.Reservation">
        UPDATE reservations
        <set>
            <if test="userId != null">
                user_id = #{userId},
            </if>
            <if test="roomId != null">
                room_id = #{roomId},
            </if>
            <if test="title != null and title != ''">
                title = #{title},
            </if>
            <if test="purpose != null and purpose != ''">
                purpose = #{purpose},
            </if>
            <if test="startTime != null">
                start_time = #{startTime},
            </if>
            <if test="endTime != null">
                end_time = #{endTime},
            </if>
            <if test="attendees != null">
                attendees = #{attendees},
            </if>
            <if test="status != null and status != ''">
                status = #{status},
            </if>
            <if test="remarks != null">
                remarks = #{remarks},
            </if>
            <if test="reviewerId != null">
                reviewer_id = #{reviewerId},
            </if>
            <if test="reviewTime != null">
                review_time = #{reviewTime},
            </if>
            <if test="reviewRemarks != null">
                review_remarks = #{reviewRemarks},
            </if>
            <if test="updatedAt != null">
                updated_at = #{updatedAt},
            </if>
            <if test="updatedAt == null">
                updated_at = CURRENT_TIMESTAMP,
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <select id="countReserve" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM reservations
        <where>
            <if test="startTime != null">
                AND start_time &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND end_time &lt;= #{endTime}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
    </select>
    <select id="countUser" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT user_id) FROM reservations
        <where>
            <if test="startTime != null">
                AND start_time &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND end_time &lt;= #{endTime}
            </if>
        </where>
    </select>
    <select id="countRoom" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT room_id) FROM reservations
        <where>
            <if test="startTime != null">
                AND start_time &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND end_time &lt;= #{endTime}
            </if>
        </where>
    </select>
    <select id="selectAvailableByRoomTypeAndTimeQuantum" resultType="com.bookingsystem.pojo.Room">
        select *
        from rooms
        where id NOT IN (select room_id
                         from reservations
                         where (#{startTime} &lt;= end_time and #{startTime} &gt;= start_time)
                            or (#{endTime} &gt;= start_time and #{endTime} &lt;= end_time))
          and room_type_id = #{roomTypeId} and status !=  0
    </select>
    <select id="list" resultType="com.bookingsystem.pojo.Reservation">
        SELECT
        re.id,
        re.user_id,
        re.room_id,
        re.title,
        re.purpose,
        re.start_time,
        re.end_time,
        re.attendees,
        re.status,
        re.remarks,
        re.reviewer_id,
        re.review_time,
        re.review_remarks,
        re.created_at,
        re.updated_at,
        rooms.name as room_name,
        u.username as username,
        u.phone as phone,
        b.name as roomLocation
        FROM reservations re
        LEFT JOIN rooms on re.room_id = rooms.id
        LEFT JOIN users u on  re.user_id = u.id
        LEFT JOIN buildings b on rooms.building_id = b.id
        <where>
            <if test="userId != null and userId != ''">
                and re.user_id = #{userId}
            </if>
            <if test="status != null and status != ''">
                and re.status = #{status}
            </if>
            <if test="startTime != null">
                and re.start_time &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                and re.end_time &lt;= #{endTime}
            </if>
            <if test="roomId != null and roomId != ''">
                and re.room_id = #{roomId}
            </if>
            <if test="roomName != null and roomName != ''">
                and rooms.name like concat ('%',#{roomName},'%')
            </if>
            <if test="username != null and username != ''">
                and u.username like concat ('%',#{username},'%')
            </if>
        </where>
        order by re.created_at desc
    </select>

    <select id="selectReservationsById" resultType="com.bookingsystem.pojo.Reservation">
        SELECT
            re.id,
            re.user_id,
            re.room_id,
            re.title,
            re.purpose,
            re.start_time,
            re.end_time,
            re.attendees,
            re.status,
            re.remarks,
            re.reviewer_id,
            re.review_time,
            re.review_remarks,
            re.created_at,
            re.updated_at,rooms.name as room_name
        FROM reservations re LEFT JOIN rooms on re.room_id = rooms.id
       where  re.id = #{id}
    </select>
    <select id="getApprovedReservations" resultType="com.bookingsystem.pojo.Reservation">
        SELECT
        re.id,
        re.user_id,
        re.room_id,
        re.title,
        re.purpose,
        re.start_time,
        re.end_time,
        re.attendees,
        re.status,
        re.remarks,
        re.reviewer_id,
        re.review_time,
        re.review_remarks,
        re.created_at,
        re.updated_at,
        rooms.name as room_name,u.username as username
        FROM reservations re
        LEFT JOIN rooms on re.room_id = rooms.id
        LEFT JOIN users u on  re.user_id = u.id
        where re.status = 'approved' and re.end_time &lt;= #{now}
        order by re.created_at desc
    </select>
    <select id="getUserReservationStats" resultType="com.bookingsystem.vo.UserReservationStatsVO">
        SELECT
            COUNT(*) AS totalCount,
            SUM(CASE WHEN status = 'completed' or status = 'approved' THEN 1 ELSE 0 END) AS completedCount,
            SUM(CASE WHEN status = 'cancelled' THEN 1 ELSE 0 END) AS cancelledCount,
            SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) AS pendingCount,
            SUM(CASE WHEN status = 'rejected' THEN 1 ELSE 0 END) AS rejectedCount
        FROM reservations
        WHERE user_id = #{userId}
    </select>

</mapper>